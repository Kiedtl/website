#!/bin/bash

name="arial"

html1='<!DOCTYPE html><html lang=en><head><link href="'
html2='" rel=icon type="image/png"><title>Kied Llaentenn</title><meta name=viewport content="width=device-width"><style>'
html3='</style>'
html4='</head><body><main>{{content}}</main></body></html>'

style='a{background:linear-gradient(to bottom,#cdcdcd,#cdcdcd) 50% calc(100% - 2px)/50% 2px no-repeat;color:#333;margin:-1px;text-decoration:none!important;-webkit-transition:all .35s ease-in-out;transition:all .35s ease-in-out}a:focus,a:hover{background-image:linear-gradient(to bottom,#777,#777);background-size:100% 3px;color:#111;-webkit-transition:all .35s ease-in-out!important;transition:all .35s ease-in-out!important}body{overflow-y:scroll;font-family:sans-serif}img,main{display:block;margin:25px auto}main{padding:20px;max-width:600px;line-height:1.6;word-wrap:break-word}img{max-width:100%}pre>code{display:block;padding:20px;white-space:pre-line}code{background:#eee;padding:2px}blockquote{border-left:7px solid #ddd;padding-left:14px;color:#666;margin:0}h1,h2,h3,h4{line-height:1.2}h1{font-family:monospace}'
favicon='data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAgAAAAIACAYAAAD0eNT6AAAACXBIWXMAAAsTAAALEwEAmpwYAAAgAElEQVR4nO3deZjV5Xn44WdYBhdAQgJWRFBrqjHGrbRGQ7kQkIIsgyRdkjStpkkQqnHfY6pF1BiXqlHEpDWmtTExxGGx4BolGLSKS9WIxSYoriDIvsP5/ZGQmvwMnhnOO99zznvff3nleueZRy/I+5nvzJzTUCqVSgEAZKVd0QsAAG1PAABAhgQAAGRIAABAhgQAAGRIAABAhgQAAGRIAABAhgQAAGRIAABAhgQAAGRIAABAhgQAAGRIAABAhgQAAGRIAABAhgQAAGRIAABAhgQAAGRIAABAhgQAAGRIAABAhgQAAGRIAABAhgQAAGRIAABAhgQAAGRIAABAhgQAAGRIAABAhgQAAGRIAABAhgQAAGRIAABAhgQAAGSoQ9ELtJUtW7bEokWLYunSpbF69erYtGlT0SsBUAUaGxujS5cu0aNHj9h3332jQ4c8rsa6/bcslUrxzDPPRHNzc8ycOTOef/55lz4AO9TY2BiHHHJIjBw5MsaMGROHH354NDQ0FL1WEg2lUqlU9BKV9Nprr8W1114bU6dOjVdffbXodQCoYX369IlPf/rTcdZZZ8Xee+9d9DoVVTcBsHLlyrjqqqvi2muvjQ0bNhS9DgB1ZJdddokzzzwzzj333Nhjjz2KXqciaj4ASqVS3HrrrXHRRRfFsmXLoqGhIWr8XwmAKrP9bvnwhz8cl19+eXz5y1+u+W8N1HQAbNy4McaPHx+33Xabix+A5LbfNV/84hfj5ptvjk6dOhW9UqvVbAAsWbIkxo4dG48++mjRqwCQof79+8fUqVOjZ8+eRa/SKjUZAIsXL47+/fv7IT8ACtWnT5+YO3du7LPPPkWv0mI190JAa9eujdGjR7v8ASjcq6++GmPGjIl169YVvUqL1VQAlEqlOOmkk+KZZ54pehUAiIiIp556Kk466aSa+zm0mgqASZMmxV133VX0GgDwW374wx/G5ZdfXvQaLVIzPwPw8ssvx0EHHRTbtm2rucoCoL41NDRE+/btY8GCBfGHf/iHRa9Tlpp5AnDhhRfG1q1bXf4AVJ1SqRRbtmyJCy+8sOhVylYTTwAee+yxOProo4teAwA+0GOPPRZHHXVU0Wt8oJp4AnDBBRcUvQIAlOX8888veoWyVP0TgMWLF0efPn2KXgMAyrZ48eLo3bt30WvsUNU/AWhubi56BQBokVq4u6o+AO6+++6iVwCAFqmFu6uqvwWwfPny6NmzZ2zdurXoVQCgbO3bt48lS5ZE9+7di17l96rqJwDz5893+QNQc7Zu3RpPPfVU0WvsUFUHwEsvvVT0CgDQKgsWLCh6hR2q6gDwhj8A1KrFixcXvcIOVXUArFq1qugVAKBVqv0Oq+oAWLt2bdErAECrrFmzpugVdqiqA6CKf0EBAHao2u+wqg4AACANAQAAGRIAAJAhAQAAGRIAAJAhAQAAGRIAAJAhAQAAGRIAAJAhAQAAGRIAAJAhAQAAGRIAAJAhAQAAGRIAAJAhAQAAGRIAAJAhAQAAGRIAAJAhAQAAGRIAAJAhAQAAGRIAAJAhAQAAGRIAAJAhAQAAGRIAAJAhAQAAGRIAAJAhAQAAGRIAAJAhAQAAGRIAAJAhAQAAGRIAAJAhAQAAGRIAAJAhAQAAGRIAAJAhAQAAGRIAAJAhAQAAGRIAAJAhAQAAGRIAAJAhAQAAGRIAAJAhAQAAGRIAAJAhAQAAGRIAAJAhAQAAGRIAAJAhAQAAGRIAAJAhAQAAGRIAAJAhAQAAGRIAAJAhAQAAGRIAAJAhAQAAGRIAAJAhAQAAGRIAAJAhAQAAGRIAAJAhAQAAGRIAAJAhAQAAGRIAAJAhAQAAGRIAAJAhAQAAGRIAAJAhAQAAGRIAAJAhAQAAGRIAAJAhAQAAGRIAAJAhAQAAGRIAAJAhAQ'
invisitext='<link rel="stylesheet" href="http://invisi-text.surge.sh/cdn/production/0.2.0/invisi-text.min.css" />'

template="${html1}${favicon}${html2}${style}${html3}${invisitext}${html4}"

if [[ -z $1 ]] then
    rm -rf _website
    printf "[${name}] cleaning out _website/*\n"

mkdir -p _website/images
mkdir -p _website/posts

for md in _content/*.md; do
    file_name=${md##*/}
    printf "[${name}] processing markdown file ${md}\n"

    [[ $file_name != index.md ]] &&
        home="<a href='/'>Home</a>"


    minify --type html \
        <<< "${template/'{{content}}'/${home}$(pandoc "$md")}" \
        > "_website/${file_name/%.md/.html}"

    home=
done

for md in _content/_posts/*.md; do
    file_name=${md##*/}
    printf "[${name}] processing markdown post ${md}\n"

    home="<a href='/'>Home</a>"

    minify --type html \
        <<< "${template/'{{content}}'/${home}$(pandoc "$md")}" \
        > "_website/blog/${file_name/%.md/.html}"

    home=
done

[[ $1 ]] &&
    exit

cd _website/images || exit

for img in ../../_content/_images/*; do (
    file_name=${img##*/}
    printf "[${name}] processing image ${img}\n"
    convert "$img" -resize 1200x\>  "$file_name"    
    img2webp -lossy -q 90 "$file_name" -o "${file_name%.png}.webp"
) & done

cd ../..

for file in _content/_files/*; do (
  printf "[${name}] moving static file $file to _site/\n"
  cp -r "$file" _website/
) & done

wait
